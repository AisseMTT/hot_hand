---
title: "hotHandAnalysis"
author: "Ben Peloquin"
date: "May 6, 2016"
output: 
  html_document:
    toc: true
    toc_depth: 2
---

Prelims
```{r}
rm(list = ls())
library(dplyr)
library(tidyr)
library(ggplot2)
setwd('/Users/benpeloquin/Desktop/Spring2016/Stats267/hot_hand')
source("analysis_helpers.R")
```

Read in data - see `get_data.py` for data collection code
```{r}
## Note this takes appr 2min to run
path <- "player_data/"
files <- list.files(path)
d.raw <- data.frame()
for (f in files) {
  d <- read.csv(paste0(path, f))
  d.raw <- rbind(d.raw, d)
}

d.player_info <- read.csv("player_info/players_info.csv") %>%
  select(player_number, age, weight, height, years_in_league, player_id, position)
names(d.player_info) <- c("PLAYER_NUMBER", "AGE", "WEIGHT", "HEIGHT", "YEARS_IN_LEAGUE", "PLAYER_ID", "POSITION")

d.raw <- full_join(d.raw, d.player_info, by = 'PLAYER_ID')
```

# Data confirmation

What kind of data do we have, generally?
```{r}
str(d.raw)
head(d.raw)
```
We have `r dim(d.raw)[1]` observations with `r dim(d.raw)[2]` predictor variables.

From the get go we can see a number of predictors we might want to recode. Looks like `GAME_ID`, `GAME_EVENT_ID`, `PLAYER_ID`, `TEAM_ID`, `PERIOD`, `SHOT_ATTEMPTED_FLAG`, and `SHOT_MADE_FLAG` should all be coded as factors (currently coded as ints). Let's also convert `SHOT_TYP` to an integer value...
```{r}
d <- d.raw %>%
  mutate(GAME_ID = as.factor(GAME_ID),
         GAME_EVENT_ID = as.factor(GAME_EVENT_ID),
         PLAYER_ID = as.factor(PLAYER_ID),
         TEAM_ID = as.factor(TEAM_ID),
         PERIOD = as.factor(PERIOD),
         SHOT_VALUE = ifelse(SHOT_TYPE == "2PT Field Goal", 2, 3))
```

We may want to do something with the two `*_TIME_REMAINING` predictors. Let's combine to get a predictor in seconds.
```{r}
d <- d %>%
  mutate(TOTAL_TIME_REMAINING = SECONDS_REMAINING + 60 * MINUTES_REMAINING)
```

Let's do some preliminary exploring just to make sure this data makes sense...

Number of players
```{r}
length(unique(d$PLAYER_ID)) == length(unique(d$PLAYER_NAME))
length(unique(d$PLAYER_ID))
```
Seems about right - should confirm this was the number of players in 2014-2015

Number of teams?
```{r}
length(unique(d$TEAM_ID))
```
Looks good, there are 30 teams

# Prelim exploration

Number of shots by player
```{r}
player_shots_summary <- d %>%
  group_by(PLAYER_NAME, TEAM_NAME) %>%
  summarize(total_shots_taken = n(),
            total_shots_made = sum(SHOT_MADE_FLAG),
            shooting_percentage = total_shots_made / total_shots_taken)

ggplot(player_shots_summary, aes(x = total_shots_taken, y = total_shots_made, col = TEAM_NAME)) +
  geom_point(alpha = 0.5, size = 4) +
  geom_smooth(method = "lm", aes(group=1)) + 
  guides(col = FALSE) +
  ggtitle("Shots made by shots taken - all players in NBA season 2014-2015")
```

Who made the most shots?
```{r}
ggplot(player_shots_summary, aes(x = reorder(PLAYER_NAME, total_shots_made), y = total_shots_made, fill = TEAM_NAME)) +
  geom_bar(stat = "identity") +
  guides(col = FALSE) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  ggtitle("Shots made by player")
``` 
Those stray lines represent players who play for multiple teams. We can ignore them for now, just interested in making sure the data looks reasonable.

OK, who were the top 50 players with the best shooting percentage of players who took more than 50 shots in the season?
```{r}
top_50_shooting_percentage <- d %>%
  group_by(PLAYER_NAME) %>%
  summarize(total_shots_taken = n(),
            total_shots_made = sum(SHOT_MADE_FLAG),
            shooting_percentage = total_shots_made / total_shots_taken,
            avg_shot_distance = mean(SHOT_DISTANCE)) %>%
  filter(total_shots_taken >= 50) %>%
  arrange(-shooting_percentage) %>%
  head(n = 50)

  ggplot(top_50_shooting_percentage, aes(x = reorder(PLAYER_NAME, shooting_percentage), y = shooting_percentage)) +
    geom_bar(stat = "identity") +
    guides(col = FALSE) +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    ggtitle("Shots made by player")
```

Interesting, what kind of shots are these guys taking? Let's look a distance...
```{r}
top50_names <- unique(top_50_shooting_percentage$PLAYER_NAME)

d %>%
  mutate(top_50 = ifelse(PLAYER_NAME %in% top50_names, TRUE, FALSE)) %>%
  group_by(PLAYER_NAME) %>%
  summarize(total_shots_taken = n(),
            total_shots_made = sum(SHOT_MADE_FLAG),
            shooting_percentage = total_shots_made / total_shots_taken,
            avg_shot_distance = mean(SHOT_DISTANCE)) %>%
  filter(total_shots_taken >= 50) %>%
  ggplot(aes(x = reorder(PLAYER_NAME, shooting_percentage), y = shooting_percentage, fill = avg_shot_distance)) +
    geom_bar(stat = "identity") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    ggtitle("Shots made by player")
```

Clearly there is an effect of location, which makes sense.

```{r}
unique(d$ACTION_TYPE)
unique(d$SHOT_TYPE)
```

# Hot hand analysis helpers

We'll want some features with tell us about a players previous shot (or previous few shots as in )
```{r}
populate_prev_shots <- function(d) {
  for (row in seq(1, nrow(d))) {
    if (row != 1) d[row, "prev_shot1"] <- d[row - 1, "SHOT_MADE_FLAG"]
    else d2[row, "prev_shot1"] <- NA
    
    if (row > 2) d[row, "prev_shot2"] <- d[row - 2, "SHOT_MADE_FLAG"]
    else d2[row, "prev_shot2"] <- NA
    
    if (row > 3) d[row, "prev_shot3"] <- d[row - 3, "SHOT_MADE_FLAG"]
    else d2[row, "prev_shot3"] <- NA
    
    if (row > 4) d[row, "prev_shot4"] <- d[row - 4, "SHOT_MADE_FLAG"]
    else d2[row, "prev_shot4"] <- NA
  }
  
  d <- d %>%
  mutate(
    ## Made prev shots
    made_last_1 = prev_shot1 == 1,
    made_last_2 = made_last_1 & prev_shot2 == 1,
    made_last_3 = made_last_2 & prev_shot3 == 1,
    made_last_4 = made_last_3 & prev_shot4 == 1,
    ## Missed prev shots
    missed_last_1 = prev_shot1 == 1,
    missed_last_2 = missed_last_1 & prev_shot2 == 0,
    missed_last_3 = missed_last_2 & prev_shot3 == 0,
    missed_last_4 = missed_last_3 & prev_shot4 == 0)
  
  d
}

ptm <- proc.time()
d2 <- populate_prev_shots(d)
proc.time() - ptm


d3 <- d %>%
  head(n = 20) %>%
  populate_prev_shots(.)

```

```{r}
d2 <- d %>%
  mutate(prev_shot1 = NA,
         prev_shot2 = NA,
         prev_shot3 = NA,
         prev_shot4 = NA) %>%
  head(n = 20)

populate_prev_shots <- function(d) {
  d <- d %>% mutate(prev_shot1 = NA,
                        prev_shot2 = NA,
                        prev_shot3 = NA,
                        prev_shot4 = NA)
  
  if (nrow(d) > 1) d$prev_shot1 <- c(NA, d$SHOT_MADE_FLAG[seq(1, length(d$SHOT_MADE_FLAG) - 1)])
  if (nrow(d) > 2) d$prev_shot2 <- c(rep(NA, 2), d$SHOT_MADE_FLAG[seq(1, length(d$SHOT_MADE_FLAG) - 2)])
  if (nrow(d) > 3) d$prev_shot3 <- c(rep(NA, 3), d$SHOT_MADE_FLAG[seq(1, length(d$SHOT_MADE_FLAG) - 3)])
  if (nrow(d) > 4) d$prev_shot4 <- c(rep(NA, 4), d$SHOT_MADE_FLAG[seq(1, length(d$SHOT_MADE_FLAG) - 4)])
  
  d
}

d4 <- d %>% head(n = 20)
populate_prev_shots(d4)


d %>% head(n = 100) %>% arrange(PLAYER_ID, GAME_ID) %>% View()

# plyr::ddply(data, .fun = rsa.runDf, 
#                   .variables = c(groupName),
d <- d %>% arrange(PLAYER_ID, GAME_ID)
ptm <- proc.time()
d7 <- plyr::ddply(d, .variables = c("PLAYER_ID", "GAME_ID"), .fun = populate_prev_shots)
proc.time() - ptm

d8 <- d7 %>%
  

d5 <- d %>% head(n = 500)
d5 <- d5 %>% arrange(PLAYER_ID, GAME_ID)
d6 <- plyr::ddply(d5, .variables = c("PLAYER_ID", "GAME_ID"), .fun = populate_prev_shots)
d7 <- d6 %>%
  mutate(
    ## Made prev shots
    made_last_1 = prev_shot1 == 1,
    made_last_2 = made_last_1 & prev_shot2 == 1,
    made_last_3 = made_last_2 & prev_shot3 == 1,
    made_last_4 = made_last_3 & prev_shot4 == 1,
    ## Missed prev shots
    missed_last_1 = prev_shot1 == 0,
    missed_last_2 = missed_last_1 & prev_shot2 == 0,
    missed_last_3 = missed_last_2 & prev_shot3 == 0,
    missed_last_4 = missed_last_3 & prev_shot4 == 0)

d7 %>% select(PLAYER_ID, GAME_ID, prev_shot1, prev_shot2, prev_shot3, prev_shot4,
              made_last_1, made_last_2, made_last_3, made_last_4,
              missed_last_1, missed_last_2, missed_last_3, missed_last_4) %>%
  View()
```

