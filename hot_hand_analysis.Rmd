---
title: "hotHandAnalysis"
author: "Ben Peloquin"
date: "May 6, 2016"
output: 
  html_document:
    toc: true
    toc_depth: 2
---

Prelims
```{r}
rm(list = ls())
library(dplyr)
library(tidyr)
library(ggplot2)
setwd('/Users/benpeloquin/Desktop/Spring2016/Stats267/hot_hand')
source("analysis_helpers.R")
```

Read in data - see `get_data.py` for data collection code
```{r}
## Note this takes appr 2min to run
path <- "player_data/"
files <- list.files(path)
d.raw <- data.frame()
for (f in files) {
  d <- read.csv(paste0(path, f))
  d.raw <- rbind(d.raw, d)
}

d.player_info <- read.csv("player_info/players_info.csv") %>%
  select(player_number, age, weight, height, years_in_league, player_id, position)
names(d.player_info) <- c("PLAYER_NUMBER", "AGE", "WEIGHT", "HEIGHT", "YEARS_IN_LEAGUE", "PLAYER_ID", "POSITION")

d.raw <- full_join(d.raw, d.player_info, by = 'PLAYER_ID')
```

# Data confirmation

What kind of data do we have, generally?
```{r}
str(d.raw)
head(d.raw)
```
We have `r dim(d.raw)[1]` observations with `r dim(d.raw)[2]` predictor variables.

From the get go we can see a number of predictors we might want to recode. Looks like `GAME_ID`, `GAME_EVENT_ID`, `PLAYER_ID`, `TEAM_ID`, `PERIOD`, `SHOT_ATTEMPTED_FLAG`, and `SHOT_MADE_FLAG` should all be coded as factors (currently coded as ints). Let's also convert `SHOT_TYP` to an integer value...
```{r}
d <- d.raw %>%
  mutate(GAME_ID = as.factor(GAME_ID),
         GAME_EVENT_ID = as.factor(GAME_EVENT_ID),
         PLAYER_ID = as.factor(PLAYER_ID),
         TEAM_ID = as.factor(TEAM_ID),
         PERIOD = as.factor(PERIOD),
         SHOT_VALUE = ifelse(SHOT_TYPE == "2PT Field Goal", 2, 3))
```

We may want to do something with the two `*_TIME_REMAINING` predictors. Let's combine to get a predictor in seconds.
```{r}
d <- d %>%
  mutate(TOTAL_TIME_REMAINING = SECONDS_REMAINING + 60 * MINUTES_REMAINING)
```

Let's do some preliminary exploring just to make sure this data makes sense...

Number of players
```{r}
length(unique(d$PLAYER_ID)) == length(unique(d$PLAYER_NAME))
length(unique(d$PLAYER_ID))
```
Seems about right - should confirm this was the number of players in 2014-2015

Number of teams?
```{r}
length(unique(d$TEAM_ID))
```
Looks good, there are 30 teams

# Prelim exploration

Number of shots by player
```{r}
player_shots_summary <- d %>%
  group_by(PLAYER_NAME, TEAM_NAME) %>%
  summarize(total_shots_taken = n(),
            total_shots_made = sum(SHOT_MADE_FLAG),
            shooting_percentage = total_shots_made / total_shots_taken)

ggplot(player_shots_summary, aes(x = total_shots_taken, y = total_shots_made, col = TEAM_NAME)) +
  geom_point(alpha = 0.5, size = 4) +
  geom_smooth(method = "lm", aes(group=1)) + 
  guides(col = FALSE) +
  ggtitle("Shots made by shots taken - all players in NBA season 2014-2015")
```

Who made the most shots?
```{r}
ggplot(player_shots_summary, aes(x = reorder(PLAYER_NAME, total_shots_made), y = total_shots_made, fill = TEAM_NAME)) +
  geom_bar(stat = "identity") +
  guides(col = FALSE) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  ggtitle("Shots made by player")
``` 
Those stray lines represent players who play for multiple teams. We can ignore them for now, just interested in making sure the data looks reasonable.

OK, who were the top 50 players with the best shooting percentage of players who took more than 50 shots in the season?
```{r}
top_50_shooting_percentage <- d %>%
  group_by(PLAYER_NAME) %>%
  summarize(total_shots_taken = n(),
            total_shots_made = sum(SHOT_MADE_FLAG),
            shooting_percentage = total_shots_made / total_shots_taken,
            avg_shot_distance = mean(SHOT_DISTANCE)) %>%
  filter(total_shots_taken >= 50) %>%
  arrange(-shooting_percentage) %>%
  head(n = 50)

  ggplot(top_50_shooting_percentage, aes(x = reorder(PLAYER_NAME, shooting_percentage), y = shooting_percentage)) +
    geom_bar(stat = "identity") +
    guides(col = FALSE) +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    ggtitle("Shots made by player")
```

Interesting, what kind of shots are these guys taking? Let's look a distance...
```{r}
top50_names <- unique(top_50_shooting_percentage$PLAYER_NAME)

d %>%
  mutate(top_50 = ifelse(PLAYER_NAME %in% top50_names, TRUE, FALSE)) %>%
  group_by(PLAYER_NAME) %>%
  summarize(total_shots_taken = n(),
            total_shots_made = sum(SHOT_MADE_FLAG),
            shooting_percentage = total_shots_made / total_shots_taken,
            avg_shot_distance = mean(SHOT_DISTANCE)) %>%
  filter(total_shots_taken >= 50) %>%
  ggplot(aes(x = reorder(PLAYER_NAME, shooting_percentage), y = shooting_percentage, fill = avg_shot_distance)) +
    geom_bar(stat = "identity") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    ggtitle("Shots made by player")
```

Clearly there is an effect of location, which makes sense.

```{r}
unique(d$ACTION_TYPE)
unique(d$SHOT_TYPE)
```

# Hot hand analysis helpers

We'll want some features with tell us about a players previous shot (or previous few shots as in )
```{r}

########
######## populate_prev_shots()
######## ---------------------
######## Appends 13 new rows:
######## * what occurred on prev shot (1-4)
######## * shot number in game (5)
######## * made streaks (6-9)
######## * missed streaks (10 - 13)
########
populate_prev_shots <- function(d) {
  
  ## Get previous shots
  get_prev_shots <- function(d) {
    d <- d %>% mutate(prev_shot1 = NA,
                          prev_shot2 = NA,
                          prev_shot3 = NA,
                          prev_shot4 = NA)
    
    if (nrow(d) > 1) d$prev_shot1 <- c(NA, d$SHOT_MADE_FLAG[seq(1, length(d$SHOT_MADE_FLAG) - 1)])
    if (nrow(d) > 2) d$prev_shot2 <- c(rep(NA, 2), d$SHOT_MADE_FLAG[seq(1, length(d$SHOT_MADE_FLAG) - 2)])
    if (nrow(d) > 3) d$prev_shot3 <- c(rep(NA, 3), d$SHOT_MADE_FLAG[seq(1, length(d$SHOT_MADE_FLAG) - 3)])
    if (nrow(d) > 4) d$prev_shot4 <- c(rep(NA, 4), d$SHOT_MADE_FLAG[seq(1, length(d$SHOT_MADE_FLAG) - 4)])
    
    d$shot_num <- seq(1, nrow(d))
    
    d
  }
  d_prev <-  plyr::ddply(d, .variables = c("PLAYER_ID", "GAME_ID"), .fun = get_prev_shots)
  
  ## Add in streak data
  res_d <- d_prev %>%
    mutate(
      ## Made prev shots
      made_last_1 = prev_shot1 == 1,
      made_last_2 = made_last_1 & prev_shot2 == 1,
      made_last_3 = made_last_2 & prev_shot3 == 1,
      made_last_4 = made_last_3 & prev_shot4 == 1,
      ## Missed prev shots
      missed_last_1 = prev_shot1 == 0,
      missed_last_2 = missed_last_1 & prev_shot2 == 0,
      missed_last_3 = missed_last_2 & prev_shot3 == 0,
      missed_last_4 = missed_last_3 & prev_shot4 == 0
    )
  
  res_d
}

ptm <- proc.time()
d_prev <- populate_prev_shots(d)
proc.time() - ptm
```

## Shooting percentage by shot number
```{r}
d_prev %>%
  group_by(shot_num) %>%
  filter(shot_num < 30) %>%
  summarize(shots_taken = n(),
            shots_made = sum(SHOT_MADE_FLAG),
            shooting_percentage = shots_made / shots_taken,
            ci_lower = binom.test(shots_made, shots_taken)$conf.int[1],
            ci_upper = binom.test(shots_made, shots_taken)$conf.int[2])
  ggplot(aes(x = shot_num, y = shooting_percentage)) +
    geom_bar(stat = "identity") +
    geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper))
```

## League wide previous shots effects

### Data
```{r}
d_current <- d_prev %>%
    summarize(shots_taken = n(),
              shots_made = sum(SHOT_MADE_FLAG),
              shooting_percentage = shots_made / shots_taken,
              ci_lower = binom.test(shots_made, shots_taken)$conf.int[1],
              ci_upper = binom.test(shots_made, shots_taken)$conf.int[2])
d_made_last_1 <- d_prev %>%
    filter(made_last_1 == TRUE) %>%
    summarize(shots_taken = n(),
              shots_made = sum(SHOT_MADE_FLAG),
              shooting_percentage = shots_made / shots_taken,
              ci_lower = binom.test(shots_made, shots_taken)$conf.int[1],
              ci_upper = binom.test(shots_made, shots_taken)$conf.int[2])
d_made_last_2 <- d_prev %>%
    filter(made_last_2 == TRUE) %>%
    summarize(shots_taken = n(),
              shots_made = sum(SHOT_MADE_FLAG),
              shooting_percentage = shots_made / shots_taken,
              ci_lower = binom.test(shots_made, shots_taken)$conf.int[1],
              ci_upper = binom.test(shots_made, shots_taken)$conf.int[2])
d_made_last_3 <- d_prev %>%
    filter(made_last_3 == TRUE) %>%
    summarize(shots_taken = n(),
              shots_made = sum(SHOT_MADE_FLAG),
              shooting_percentage = shots_made / shots_taken,
              ci_lower = binom.test(shots_made, shots_taken)$conf.int[1],
              ci_upper = binom.test(shots_made, shots_taken)$conf.int[2])
d_made_last_4 <- d_prev %>%
    filter(made_last_4 == TRUE) %>%
    summarize(shots_taken = n(),
              shots_made = sum(SHOT_MADE_FLAG),
              shooting_percentage = shots_made / shots_taken,
              ci_lower = binom.test(shots_made, shots_taken)$conf.int[1],
              ci_upper = binom.test(shots_made, shots_taken)$conf.int[2])
d_missed_last_1 <- d_prev %>%
    filter(missed_last_1 == TRUE) %>%
    summarize(shots_taken = n(),
              shots_made = sum(SHOT_MADE_FLAG),
              shooting_percentage = shots_made / shots_taken,
              ci_lower = binom.test(shots_made, shots_taken)$conf.int[1],
              ci_upper = binom.test(shots_made, shots_taken)$conf.int[2])
d_missed_last_2 <- d_prev %>%
    filter(made_last_2 == TRUE) %>%
    summarize(shots_taken = n(),
              shots_made = sum(SHOT_MADE_FLAG),
              shooting_percentage = shots_made / shots_taken,
              ci_lower = binom.test(shots_made, shots_taken)$conf.int[1],
              ci_upper = binom.test(shots_made, shots_taken)$conf.int[2])
d_missed_last_3 <- d_prev %>%
    filter(made_last_3 == TRUE) %>%
    summarize(shots_taken = n(),
              shots_made = sum(SHOT_MADE_FLAG),
              shooting_percentage = shots_made / shots_taken,
              ci_lower = binom.test(shots_made, shots_taken)$conf.int[1],
              ci_upper = binom.test(shots_made, shots_taken)$conf.int[2])
d_missed_last_4 <- d_prev %>%
    filter(made_last_4 == TRUE) %>%
    summarize(shots_taken = n(),
              shots_made = sum(SHOT_MADE_FLAG),
              shooting_percentage = shots_made / shots_taken,
              ci_lower = binom.test(shots_made, shots_taken)$conf.int[1],
              ci_upper = binom.test(shots_made, shots_taken)$conf.int[2])

d_prev_shot_effects <- rbind(d_made_last_1,
                             d_made_last_2,
                             d_made_last_3,
                             d_made_last_4,
                             d_current,
                             d_missed_last_1,
                             d_missed_last_2,
                             d_missed_last_3,
                             d_missed_last_4) %>%
  mutate(context = c('made_1',
                     'made_2',
                     'made_3',
                     'made_4',
                     'overall',
                     'missed_1',
                     'missed_2',
                     'missed_3',
                     'missed_4'))

d_prev_shot_effects$context <- factor(d_prev_shot_effects$context, levels = c('made_4',
                                                                              'made_3',
                                                                              'made_2',
                                                                              'made_1',
                                                                              'overall',
                                                                              'missed_1',
                                                                              'missed_2',
                                                                              'missed_3',
                                                                              'missed_4'))
```

### Plot
```{r}
ggplot(d_prev_shot_effects, aes(x = context, y = shooting_percentage)) +
  geom_bar(stat = "identity") +
  geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper)) +
  ggtitle("Impact of previous shot on current shooting percentage\n
          All shots from NBA 2014-2015 season")
```

# Modeling
```{r}
summary(glm(SHOT_MADE_FLAG ~ SHOT_TYPE +
              MINUTES_REMAINING +
              missed_last_1 +
              made_last_1 +
              made_last_2 +
              made_last_3 + 
              made_last_4,
            family = "binomial", na.action = "na.omit", data = d_prev))
```

